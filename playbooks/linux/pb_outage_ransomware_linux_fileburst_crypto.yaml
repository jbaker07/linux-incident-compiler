id: pb_outage_ransomware_linux_fileburst_crypto
version: 1
name: "Ransomware (Linux): File Burst + Crypto Exec"
severity: high
description: Detects ransomware by correlating mass file modifications with crypto tooling and (optionally) memory exec & ransom note drops.
window_sec: 1800         # 30m correlation window to survive staggered stages
cooldown_sec: 3600

context_keys: [host, user]    # used to stitch slots into one hypothesis

required:
  - slot_id: file_burst
    slot_ttl_sec: 600
    fact: FileIO
    where:
      - {field: op, op: in, value: [write, rename]}
      - {field: topdir, op: in, value: [/home, /var/www, /srv, /mnt, /opt, /media, /run/user]}
      # Aggregated signature of mass encryption activity
      - {field: __agg.kind, op: eq, value: file_burst}
      - {field: __agg.files, op: gte, value: 500}
      - {field: __agg.distinct_topdirs, op: gte, value: 3}
      - {field: __agg.window_sec, op: lte, value: 600}
    derive_tags: ["T1486"]    # Data Encrypted for Impact

  - slot_id: crypto_exec
    slot_ttl_sec: 420
    fact: Exec
    where:
      # common crypto tools & archivers often abused; includes options presence
      - {field: exe, op: regex, value: "^(?:/usr/(?:local/)?bin/)?(openssl|gpg|age|7z|rar|pigz|xz|zip|zstd)$"}
      - {field: cmd, op: contains, value: "-"}
    derive_tags: ["T1486", "T1059"]

optional:
  # Memory execution / code-injection style signals (if you emit tags for RWX/MEMFD)
  - slot_id: mem_exec
    slot_ttl_sec: 900
    fact: Event
    where:
      - {field: tag, op: in, value: [MEMFD_EXEC, RWX_MAP]}
    derive_tags: ["T1055"]

  # Backup/DB/service interference on Linux
  - slot_id: backup_disable
    slot_ttl_sec: 900
    fact: Exec
    where:
      - {field: cmd, op: regex, value: "(systemctl\\s+stop\\s+(mysql|mariadb|postgresql|mongod|backup|rsnapshot)|chattr\\s+\\+i|lvremove\\s|zfs\\s+destroy|btrfs\\s+subvolume\\s+delete)"}
    derive_tags: ["T1489"]   # Service Stop / Inhibit Recovery

  # Extension surge on rename
  - slot_id: new_exts
    slot_ttl_sec: 600
    fact: FileIO
    where:
      - {field: op, op: eq, value: rename}
      - {field: ext_new, op: in, value: [.enc, .lock, .locked, .crypt, .encrypted, .pay, .payme]}
    derive_tags: ["T1486"]

  # Ransom note placement (content/filename)
  - slot_id: ransom_notes
    slot_ttl_sec: 1200
    fact: FileIO
    where:
      - {field: op, op: in, value: [write, create]}
      - {field: filename, op: regex, value: "(README|HOW_TO_DECRYPT|RECOVER_FILES|DECRYPT_INSTRUCTIONS|CONTACT)\\.(txt|html|md)$"}
      - {field: file_sample, op: contains_any, value: [decrypt, ransom, bitcoin, contact, private key]}
      - {field: __agg.distinct_dirs, op: gte, value: 50}
    derive_tags: ["T1486"]

  # Network share encryption burst (Linux encrypting SMB/NFS mounts)
  - slot_id: net_share_burst
    slot_ttl_sec: 900
    fact: FileIO
    where:
      - {field: mount_fstype, op: in, value: [cifs, nfs, nfs4, smb3]}
      - {field: __agg.files, op: gte, value: 300}
      - {field: __agg.distinct_mounts, op: gte, value: 2}
    derive_tags: ["T1021.002", "T1486"]

forbidden:
  # Legitimate, high-churn maintenance
  - slot_id: corporate_backup_agent
    slot_ttl_sec: 1800
    fact: Exec
    where:
      - {field: exe, op: regex, value: "^(?:/opt|/usr)/(veeam|netbackup|cohesity|rubrik|commvault|datto|bacula)/"}
      - {field: cmd, op: contains, value: backup}

  - slot_id: package_manager_burst
    slot_ttl_sec: 1200
    fact: Exec
    where:
      - {field: exe, op: regex, value: "^(?:/usr/(?:local/)?bin/)?(apt|apt-get|dpkg|yum|dnf|rpm)$"}
    notes: Exclude package install bursts under /usr*, /var/lib/*

links:
  # Cross-layer, same user/host; either order allowed but must be close
  - {from: file_burst, to: crypto_exec, requires: [same_host, same_user], follows_within_sec: 300}
  - {from: crypto_exec, to: file_burst, requires: [same_host, same_user], follows_within_sec: 600}
  # Optional evidence strengthens narrative/severity if present
  - {from: mem_exec, to: file_burst, requires: [same_host], follows_within_sec: 900}
  - {from: backup_disable, to: file_burst, requires: [same_host, same_user], follows_within_sec: 900}
  - {from: new_exts, to: file_burst, requires: [same_host], follows_within_sec: 600}
  - {from: net_share_burst, to: file_burst, requires: [same_host], follows_within_sec: 900}
  - {from: ransom_notes, to: file_burst, requires: [same_host], follows_within_sec: 1800}

vendor_map:
  - {product: CrowdStrike, alert_type: "Suspicious Mass File Modification", fills_slot: file_burst}
  - {product: Elastic, alert_type: "Ransomware behavior", fills_slot: file_burst}
  - {product: Elastic, alert_type: "Encryption tool execution", fills_slot: crypto_exec}

# Treat playbook satisfaction as ground truth; anomalies/vendors only increase confidence
emit_ground_truth: true

explain:
  primary_ttp: T1486
  steps_template:
    - "Mass file modifications in {{file_burst.__agg.distinct_topdirs}} top dirs ({{file_burst.__agg.files}} files over {{file_burst.__agg.window_sec}}s)."
    - "Crypto tooling executed: {{crypto_exec.exe}} {{crypto_exec.cmd}}."
    - "{{#if backup_disable}}Services/snapshots disabled: {{backup_disable.cmd}}{{/if}}"
    - "{{#if new_exts}}New encrypted extensions observed (e.g., {{new_exts.ext_new}}).{{/if}}"
    - "{{#if ransom_notes}}Ransom notes dropped in {{ransom_notes.__agg.distinct_dirs}} dirs.{{/if}}"
    - "{{#if mem_exec}}Memory exec indicator present ({{mem_exec.tag}}).{{/if}}"
  narrative: >
    Mass file modification across user data plus crypto tooling indicates active encryption. Optional service disablement,
    ransom-note placement, and memory-exec signals further corroborate ransomware behavior.
title: "Ransomware (Linux): File Burst + Crypto Exec"
reason_code: OUTAGE_RANSOMWARE_LINUX_FILEBURST_CRYPTO
rules: []
