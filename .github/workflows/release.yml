name: Release

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  build-linux:
    name: Build Linux Release
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libelf-dev libbpf-dev jq

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-release-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-release-

      - name: Verify formatting
        run: cargo fmt -- --check

      - name: Clippy check
        run: cargo clippy --workspace --all-targets -- -D warnings
        env:
          RUSTFLAGS: "-D warnings"

      - name: Run tests
        run: cargo test --workspace --release

      - name: Build release binaries
        run: cargo build --workspace --release
        env:
          RUSTFLAGS: "-D warnings"

      - name: Build agent-linux with eBPF
        run: cargo build --release -p agent-linux --features with-ebpf

      - name: Collect artifacts
        run: |
          set -e

          # Load canonical allowlist (single source of truth)
          allowlist_path="packaging/allowlist.json"
          if [ ! -f "$allowlist_path" ]; then
            echo "FATAL: packaging/allowlist.json not found!"
            exit 1
          fi

          ALLOWED_BINARIES=$(jq -r '.allowed_binaries[]' "$allowlist_path")
          FORBIDDEN_BINARIES=$(jq -r '.forbidden_binaries[]' "$allowlist_path")

          dist_dir="dist"
          target_release="target/release"
          ui_dir="ui"
          docs_dir="docs"

          echo "=== Build Diagnostics ==="
          echo "Working directory: $PWD"
          echo "Target release dir: $target_release"
          echo ""

          # Verify target/release exists and show contents
          if [ ! -d "$target_release" ]; then
            echo "ERROR: $target_release does not exist!"
            exit 1
          fi

          echo "Contents of target/release:"
          ls -la "$target_release"/*.* 2>/dev/null | head -20 || true
          echo ""

          # Create dist directory
          mkdir -p "$dist_dir"
          echo "Created: $dist_dir"

          # Copy allowed binaries only
          echo ""
          echo "=== Copying Allowed Binaries ==="
          for bin in $ALLOWED_BINARIES; do
            src="$target_release/$bin"
            if [ -f "$src" ]; then
              cp "$src" "$dist_dir/"
              echo "  ✓ Copied: $bin"
            else
              echo "  ✗ MISSING: $bin"
              exit 1
            fi
          done

          # Verify NO forbidden binaries in dist
          echo ""
          echo "=== Verifying No Forbidden Binaries ==="
          for forbidden in $FORBIDDEN_BINARIES; do
            if [ -f "$dist_dir/$forbidden" ]; then
              echo "  ✗ VIOLATION: $forbidden in dist!"
              exit 1
            fi
            echo "  ✓ Excluded: $forbidden"
          done

          # Copy UI files
          if [ -d "$ui_dir" ]; then
            mkdir -p "$dist_dir/ui"
            cp -r "$ui_dir"/* "$dist_dir/ui/"
            echo "  ✓ Copied UI files"
          fi

          # Copy docs
          if [ -d "$docs_dir" ]; then
            mkdir -p "$dist_dir/docs"
            cp -r "$docs_dir"/* "$dist_dir/docs/"
            echo "  ✓ Copied docs"
          fi

          # Copy playbooks
          if [ -d "playbooks" ]; then
            mkdir -p "$dist_dir/playbooks"
            cp -r playbooks/* "$dist_dir/playbooks/"
            echo "  ✓ Copied playbooks"
          fi

          # Copy license
          cp LICENSE "$dist_dir/" 2>/dev/null || true
          cp README.md "$dist_dir/" 2>/dev/null || true

          # Create version file
          echo "${{ github.ref_name }}" > "$dist_dir/VERSION"

          # Final verification
          echo ""
          echo "=== Final dist contents ==="
          find "$dist_dir" -type f | head -30

      - name: Security scan binaries
        run: |
          set -e

          FORBIDDEN_PATTERNS=(
            "SigningKey"
            "PRIVATE_KEY"
            "EDR_LICENSE_PRIVATE_KEY"
            "-----BEGIN PRIVATE KEY-----"
            "ed25519_secret"
          )

          echo "=== Security Scan ==="
          violations=0

          for bin in dist/edr-server dist/edr-locald dist/capture_linux_rotating; do
            if [ ! -f "$bin" ]; then
              continue
            fi
            echo "Scanning: $bin"
            for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
              if strings "$bin" | grep -q "$pattern"; then
                echo "  ✗ Found: $pattern"
                violations=$((violations + 1))
              fi
            done
          done

          if [ $violations -gt 0 ]; then
            echo "SECURITY VIOLATION: Found sensitive strings!"
            exit 1
          fi

          echo "✓ Security scan passed"

      - name: Create release archive
        run: |
          VERSION="${{ github.ref_name }}"
          ARCHIVE_NAME="linux-incident-compiler-${VERSION}-linux-x64.tar.gz"
          tar -czf "$ARCHIVE_NAME" -C dist .
          echo "archive_name=$ARCHIVE_NAME" >> $GITHUB_ENV
          echo "Created: $ARCHIVE_NAME"
          ls -la "$ARCHIVE_NAME"

      - name: Generate MANIFEST
        run: |
          echo "=== MANIFEST ===" > dist/MANIFEST.txt
          echo "Version: ${{ github.ref_name }}" >> dist/MANIFEST.txt
          echo "Build Date: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> dist/MANIFEST.txt
          echo "Platform: linux-x64" >> dist/MANIFEST.txt
          echo "" >> dist/MANIFEST.txt
          echo "Files:" >> dist/MANIFEST.txt
          find dist -type f -exec sha256sum {} \; | sed 's|dist/||' >> dist/MANIFEST.txt
          cat dist/MANIFEST.txt

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-incident-compiler-${{ github.ref_name }}-linux-x64
          path: dist/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ${{ env.archive_name }}
            dist/MANIFEST.txt
          body: |
            ## Linux Incident Compiler ${{ github.ref_name }}

            ### Installation (Linux x64)

            ```bash
            # Download and extract
            tar -xzf linux-incident-compiler-${{ github.ref_name }}-linux-x64.tar.gz

            # Start capture (requires root for eBPF)
            sudo ./capture_linux_rotating --output ./run

            # Start server
            ./edr-server --port 8080

            # Open UI
            xdg-open http://localhost:8080
            ```

            ### Components
            - `capture_linux_rotating` - eBPF-based Linux event capture
            - `edr-locald` - Local hypothesis engine
            - `edr-server` - Web server and REST API
            - `ui/` - Web interface

            ### Requirements
            - Linux kernel 5.4+ (for eBPF CO-RE)
            - libbpf installed
            - Root privileges for capture agent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ═══════════════════════════════════════════════════════════════════════════
  # Build .deb package (Ubuntu/Debian)
  # ═══════════════════════════════════════════════════════════════════════════
  build-deb:
    name: Build .deb Package
    runs-on: ubuntu-22.04
    needs: build-linux

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential pkg-config libssl-dev \
            libelf-dev libbpf-dev \
            dpkg-dev fakeroot

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: deb-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Build .deb package
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"  # Strip 'v' prefix
          export VERSION
          chmod +x packaging/deb/build-deb.sh
          ./packaging/deb/build-deb.sh

      - name: Upload .deb artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-incident-compiler-${{ github.ref_name }}-amd64.deb
          path: target/*.deb

      - name: Add .deb to release
        uses: softprops/action-gh-release@v2
        with:
          files: target/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ═══════════════════════════════════════════════════════════════════════════
  # Build .rpm package (Rocky/RHEL)
  # ═══════════════════════════════════════════════════════════════════════════
  build-rpm:
    name: Build .rpm Package
    runs-on: ubuntu-latest
    container: rockylinux:9
    needs: build-linux

    steps:
      - name: Install build tools
        run: |
          dnf install -y epel-release
          dnf config-manager --set-enabled crb || true
          dnf install -y \
            gcc gcc-c++ make openssl-devel pkgconf-pkg-config \
            elfutils-libelf-devel libbpf-devel \
            rpm-build rpmdevtools rsync curl ca-certificates git

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
        env:
          RUSTUP_HOME: /usr/local/rustup
          CARGO_HOME: /usr/local/cargo

      - name: Set Rust environment
        run: |
          . "$HOME/.cargo/env"
          echo "PATH=$HOME/.cargo/bin:$PATH" >> $GITHUB_ENV

      - name: Build .rpm package
        run: |
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"  # Strip 'v' prefix
          export VERSION
          chmod +x packaging/rpm/build-rpm.sh
          ./packaging/rpm/build-rpm.sh

      - name: Upload .rpm artifact
        uses: actions/upload-artifact@v4
        with:
          name: linux-incident-compiler-${{ github.ref_name }}.rpm
          path: target/*.rpm

      - name: Add .rpm to release
        uses: softprops/action-gh-release@v2
        with:
          files: target/*.rpm
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ═══════════════════════════════════════════════════════════════════════════
  # Build Tauri Desktop App
  # ═══════════════════════════════════════════════════════════════════════════
  build-tauri:
    name: Build Tauri Desktop
    runs-on: ubuntu-22.04
    needs: build-linux

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Tauri dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libwebkit2gtk-4.1-dev \
            libgtk-3-dev \
            librsvg2-dev \
            libayatana-appindicator3-dev

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            src-tauri/target
          key: tauri-release-${{ hashFiles('**/Cargo.lock') }}

      - name: Install UI dependencies
        working-directory: ui
        run: npm ci

      - name: Build Tauri app
        working-directory: src-tauri
        run: cargo build --release

      - name: Package Tauri binary
        run: |
          VERSION="${{ github.ref_name }}"
          mkdir -p dist-tauri
          cp src-tauri/target/release/edr-desktop dist-tauri/ 2>/dev/null || \
            cp src-tauri/target/release/linux-incident-compiler dist-tauri/edr-desktop
          tar -czf "edr-desktop-${VERSION}-linux-x64.tar.gz" -C dist-tauri .

      - name: Upload Tauri artifact
        uses: actions/upload-artifact@v4
        with:
          name: edr-desktop-${{ github.ref_name }}-linux-x64
          path: edr-desktop-*.tar.gz

      - name: Add Tauri to release
        uses: softprops/action-gh-release@v2
        with:
          files: edr-desktop-*.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
