name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

env:
  CARGO_TERM_COLOR: always
  RUSTFLAGS: "-D warnings"

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: clippy, rustfmt

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libelf-dev libbpf-dev

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy (core)
        run: cargo clippy --workspace --all-targets -- -D warnings

      - name: Run clippy (pro)
        run: cargo clippy --workspace --all-targets --features pro -- -D warnings

      - name: Build release (core)
        run: cargo build --release --workspace

      - name: Build release (pro)
        run: cargo build --release --workspace --features pro

      - name: Build agent-linux with eBPF
        run: cargo build --release -p agent-linux --features with-ebpf

      - name: Run tests (core)
        run: cargo test --workspace

      - name: Run tests (pro)
        run: cargo test --workspace --features pro

      - name: Run golden Linux integration test
        run: cargo test -p edr-locald --test golden_linux_integration -- --nocapture

  # Security: Verify binaries don't contain sensitive material
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Build release binaries
        run: cargo build --workspace --release

      - name: Scan binaries for sensitive strings
        run: |
          set -e

          SHIPPING_BINARIES=(
            "target/release/edr-server"
            "target/release/edr-locald"
            "target/release/capture_linux_rotating"
          )

          # Patterns that should NEVER appear in shipping binaries
          FORBIDDEN_PATTERNS=(
            "SigningKey"
            "PRIVATE_KEY"
            "EDR_LICENSE_PRIVATE_KEY"
            "-----BEGIN PRIVATE KEY-----"
            "ed25519_secret"
          )

          echo "=== Security Scan: Checking binaries for sensitive strings ==="
          violations=0

          for bin in "${SHIPPING_BINARIES[@]}"; do
            if [ ! -f "$bin" ]; then
              echo "  ⚠ Skipping (not found): $bin"
              continue
            fi

            echo "  Scanning: $bin"
            for pattern in "${FORBIDDEN_PATTERNS[@]}"; do
              if strings "$bin" | grep -q "$pattern"; then
                echo "    ✗ Found forbidden pattern: $pattern"
                violations=$((violations + 1))
              fi
            done
          done

          if [ $violations -gt 0 ]; then
            echo ""
            echo "=== SECURITY VIOLATIONS ==="
            exit 1
          fi

          echo ""
          echo "✓ Security scan passed - no sensitive strings found"

  # Verify artifact allowlist
  artifact-allowlist:
    name: Verify Artifact Allowlist
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Build release binaries
        run: cargo build --workspace --release

      - name: Verify artifact allowlist
        run: |
          set -e

          # Load canonical allowlist (single source of truth)
          allowlist_path="packaging/allowlist.json"
          if [ ! -f "$allowlist_path" ]; then
            echo "FATAL: packaging/allowlist.json not found!"
            exit 1
          fi

          echo "=== Artifact Allowlist Verification ==="
          echo "Source: packaging/allowlist.json"
          echo ""

          # Check allowed binaries exist
          echo "Checking required binaries..."
          for bin in $(jq -r '.allowed_binaries[]' "$allowlist_path"); do
            path="target/release/$bin"
            if [ -f "$path" ]; then
              echo "  ✓ Found: $bin"
            else
              echo "  ✗ MISSING: $bin"
              exit 1
            fi
          done

          # Check forbidden binaries (should NOT be shipped)
          echo ""
          echo "Verifying forbidden binaries..."
          for forbidden in $(jq -r '.forbidden_binaries[]' "$allowlist_path"); do
            path="target/release/$forbidden"
            if [ -f "$path" ]; then
              echo "  ⚠ Built (correctly excluded from shipping): $forbidden"
            fi
          done

          echo ""
          echo "✓ Artifact allowlist verification passed"
